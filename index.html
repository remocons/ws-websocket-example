<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>IOSignal client</title>
</head>

<body>
  <h2>Status: <span id="status">Disconnected</span></h2>
  <button id="sendText">send text</button>
  <button id="sendBinary">send binary</button>
  <h2>Messages:</h2>
  <ul id="messages"></ul>

  <script>

    const status = document.getElementById('status');
    const messages = document.getElementById('messages');

    const appendMessage = content => {
      const item = document.createElement('li');
      item.textContent = content;
      if (messages.childElementCount > 10) messages.innerHTML = ""
      messages.appendChild(item);
    };

    let url = new URL(document.URL)
    if (url.protocol == 'https:') {
      url.protocol = 'wss'
    } else {
      url.protocol = 'ws'
    }
    let wsURL = url.href
    console.log('ws url', wsURL)

    // fircat io client.
    let socket = new WebSocket(wsURL)
    socket.binaryType = "arraybuffer";

    socket.onopen = function (e) {
      status.innerText = "open"
      socket.send("hello this is browser.");
    };

    socket.onmessage = function (event) {
      if( event.data instanceof ArrayBuffer ){
        //binary frame
        let data = new Uint8Array( event.data )
        appendMessage(`[message] 서버로부터 전송받은 binary frame: ${ data }`);
        

      }else{
        //text frame
        appendMessage(`[message] 서버로부터 전송받은 text frame: ${event.data}`);
      }
    };

    socket.onclose = function (event) {
      status.innerText = "close"

      if (event.wasClean) {
        appendMessage(`[close] 커넥션이 정상적으로 종료되었습니다(code=${event.code} reason=${event.reason})`);
      } else {
        appendMessage('[close] 커넥션이 죽었습니다.');
      }
    };

    socket.onerror = function (error) {
      appendMessage(`[error]`);
    };


    sendText.addEventListener('click', ()=>{
      socket.send( "text message" )
    })
    sendBinary.addEventListener('click', ()=>{
      let buffer = new Uint8Array(20)
      socket.send( buffer )
    })

  </script>
</body>